<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>NookLife v11: Custom</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&display=swap');

        :root {
            /* === ç™½å¤©é…è‰² (é»˜è®¤) === */
            --bg-color: #F7F5E6;
            --bg-pattern: #8DD7B1;
            --text-color: #5C5042;
            --card-bg: #FFFEF5;
            --card-border: #E6E2D0;
            --btn-bg: #8DD7B1;
            --btn-shadow: #6FB591;
            --accent: #F4A261;
        }

        /* === é»‘å¤œæ¨¡å¼ === */
        body.night {
            --bg-color: #2C3E50;
            --bg-pattern: #34495E;
            --text-color: #ECF0F1;
            --card-bg: #34495E;
            --card-border: #2C3E50;
            --btn-bg: #1ABC9C;
            --btn-shadow: #16A085;
            --accent: #F1C40F;
        }

        body {
            font-family: 'Nunito', system-ui, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0;
            min-height: 100vh;
            background-image: radial-gradient(var(--bg-pattern) 15%, transparent 16%);
            background-size: 24px 24px;
            transition: background 1s, color 1s;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            padding-bottom: 50px;
        }

        .container { max-width: 420px; margin: 0 auto; padding: 20px; position: relative; }

        /* === é¡¶éƒ¨æ  === */
        .status-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 5px; font-weight: 900; opacity: 0.7; font-size: 0.8rem;
        }

        /* === é¦–é¡µå¤´éƒ¨ === */
        .passport {
            background: var(--card-bg); border-radius: 25px;
            padding: 20px; margin-bottom: 30px;
            box-shadow: 0 8px 0 rgba(0,0,0,0.1);
            border: 4px solid var(--card-border);
            position: relative; overflow: hidden;
            transition: 0.3s;
        }
        .passport-info { display: flex; align-items: center; gap: 15px; }
        .avatar { 
            font-size: 2.5rem; background: #FFF; width: 60px; height: 60px; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            border: 3px solid var(--accent);
        }
        
        /* === ä¹å®«æ ¼ === */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .app-btn {
            background: var(--card-bg); border-radius: 25px;
            aspect-ratio: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            box-shadow: 0 6px 0 rgba(0,0,0,0.1); cursor: pointer;
            transition: transform 0.1s; border: 2px solid var(--card-border);
        }
        .app-btn:active { transform: translateY(5px); box-shadow: none; }
        .app-icon { font-size: 3rem; margin-bottom: 5px; filter: drop-shadow(0 4px 0 rgba(0,0,0,0.1)); }
        .app-label { font-weight: 800; font-size: 0.9rem; }

        /* === å­é¡µé¢ === */
        .sub-page { 
            display: none; position: fixed; inset: 0; background: var(--bg-color);
            z-index: 100; padding: 20px; overflow-y: auto;
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .sub-page.active { display: block; }
        .nav-back {
            background: var(--card-border); padding: 8px 20px; border-radius: 20px;
            display: inline-block; margin-bottom: 20px; font-weight: 900; cursor: pointer;
        }

        /* === ä»»åŠ¡å¡ç‰‡ === */
        .task-card {
            background: var(--card-bg); padding: 15px; border-radius: 20px;
            margin-bottom: 15px; border-left: 8px solid #ccc;
            box-shadow: 0 4px 0 rgba(0,0,0,0.05); position: relative;
        }
        /* åŠ¨æ€é¢œè‰²ç±» (jsç”Ÿæˆ) */
        .tag-color-0 { border-color: #6BA2F0 !important; }
        .tag-color-1 { border-color: #F06B6B !important; }
        .tag-color-2 { border-color: #A86BF0 !important; }
        .tag-color-3 { border-color: #F06BC9 !important; }
        .tag-color-4 { border-color: #F4A261 !important; }
        .tag-color-5 { border-color: #2ECC71 !important; }

        .btn-action {
            width: 100%; background: var(--btn-bg); color: #fff; border: none;
            padding: 12px; border-radius: 15px; font-weight: 900; margin-top: 10px;
            box-shadow: 0 4px 0 var(--btn-shadow); cursor: pointer;
        }
        .btn-action:active { transform: translateY(4px); box-shadow: none; }

        .btn-del {
            position: absolute; top: 10px; right: 10px;
            color: #ff9999; cursor: pointer; font-size: 1.2rem;
            width: 30px; height: 30px; line-height: 30px; text-align: center;
        }

        /* === åˆ†ç±»ç®¡ç† (Tag Manager) === */
        .tag-manager {
            display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;
        }
        .tag-pill {
            background: #fff; padding: 5px 12px; border-radius: 20px;
            border: 2px solid #eee; font-size: 0.8rem; font-weight: bold;
            display: flex; align-items: center; gap: 5px;
        }
        .tag-pill span { color: red; cursor: pointer; margin-left: 5px; }

        /* === å¼¹çª— === */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px);
            z-index: 200; display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: var(--card-bg); padding: 25px; border-radius: 30px; width: 80%;
            border: 4px solid var(--btn-bg); text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            animation: popIn 0.3s;
        }
        input, select {
            width: 100%; padding: 12px; margin: 10px 0; border-radius: 12px;
            border: 2px solid #ccc; background: #fff; font-family: inherit; box-sizing: border-box;
        }
        
        @keyframes slideUp { from{transform:translateY(100%);} to{transform:translateY(0);} }
        @keyframes popIn { from{transform:scale(0.8);} to{transform:scale(1);} }

        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--text-color); color: var(--bg-color); padding: 10px 25px;
            border-radius: 50px; font-weight: 800; z-index: 300; display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<div class="container">
    <div class="status-bar">
        <div id="clock">12:00</div>
        <div id="day-icon">â˜€ï¸</div>
    </div>

    <!-- é¦–é¡µ -->
    <div id="home">
        <div class="passport">
            <div class="passport-info">
                <div class="avatar">ğŸ¦Š</div>
                <div>
                    <div style="font-size:0.8rem; opacity:0.7">NOOK MILES</div>
                    <div style="font-size:1.5rem; color:var(--accent)">âœˆï¸ <span id="gold">0</span></div>
                </div>
            </div>
            <div style="margin-top:15px;">
                <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:5px;">
                    <span>Level <span id="lvl">1</span></span>
                    <span id="xp-text">0/100</span>
                </div>
                <div style="background:rgba(0,0,0,0.1); height:10px; border-radius:5px; overflow:hidden;">
                    <div id="xp-bar" style="width:0%; height:100%; background:var(--accent); transition:0.5s"></div>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="app-btn" onclick="openPage('tasks')">
                <div class="app-icon">ğŸ“‹</div>
                <div class="app-label">æ‰“å¡è®¡åˆ’</div>
            </div>
            <div class="app-btn" onclick="openPage('boss')">
                <div class="app-icon">ğŸ¦‹</div>
                <div class="app-label">æ•æ‰ç›®æ ‡</div>
            </div>
            <div class="app-btn" onclick="openPage('shop')">
                <div class="app-icon">ğŸƒ</div>
                <div class="app-label">ç‹¸ç«¯æœº</div>
            </div>
            <div class="app-btn" onclick="openPage('profile')">
                <div class="app-icon">ğŸ“±</div>
                <div class="app-label">æˆ‘çš„æŠ¤ç…§</div>
            </div>
        </div>
    </div>

    <!-- ä»»åŠ¡é¡µé¢ -->
    <div id="page-tasks" class="sub-page">
        <div class="nav-back" onclick="closePage()">â¬… è¿”å›æ¡Œé¢</div>
        <div class="passport" onclick="openModal('modal-task')" style="text-align:center; border-style:dashed; cursor:pointer; color:var(--accent);">
            ï¼‹ æ–°å¢è®¡åˆ’
        </div>
        <div id="task-list"></div>
    </div>

    <!-- Boss é¡µé¢ -->
    <div id="page-boss" class="sub-page">
        <div class="nav-back" onclick="closePage()">â¬… è¿”å›æ¡Œé¢</div>
        <div class="passport" onclick="openModal('modal-boss')" style="text-align:center; border-style:dashed; cursor:pointer; color:var(--accent);">
            ï¼‹ è®¾å®šç›®æ ‡
        </div>
        <div id="boss-list"></div>
    </div>

    <!-- å•†åº—é¡µé¢ -->
    <div id="page-shop" class="sub-page">
        <div class="nav-back" onclick="closePage()">â¬… è¿”å›æ¡Œé¢</div>
        <h2>ğŸƒ å“©æ•°å…‘æ¢</h2>
        <div id="shop-list" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
    </div>

    <!-- æŠ¤ç…§/è®¾ç½®é¡µé¢ (æ–°å¢åˆ†ç±»ç®¡ç†) -->
    <div id="page-profile" class="sub-page">
        <div class="nav-back" onclick="closePage()">â¬… è¿”å›æ¡Œé¢</div>
        <h2>ğŸ·ï¸ åˆ†ç±»ç®¡ç† (Tags)</h2>
        <div style="background:var(--card-bg); padding:15px; border-radius:20px; border:2px solid var(--card-border); margin-bottom:20px;">
            <p style="font-size:0.8rem; margin-top:0; color:#888;">è‡ªå®šä¹‰ä½ çš„ä»»åŠ¡åˆ†ç±»ï¼š</p>
            <div id="tag-list" class="tag-manager"></div>
            <div style="display:flex; gap:10px;">
                <input id="in-new-tag" placeholder="æ–°åˆ†ç±»åç§°" style="margin:0;">
                <button onclick="addTag()" style="background:var(--btn-bg); border:none; border-radius:10px; color:#fff; font-weight:bold; padding:0 15px;">æ·»åŠ </button>
            </div>
        </div>

        <h2>ğŸ’¾ æ•°æ®å¤‡ä»½</h2>
        <div style="text-align:center;">
            <button class="nav-back" onclick="exportData()">å¤‡ä»½å­˜æ¡£</button>
            <button class="nav-back" onclick="importData()">è¯»å–å­˜æ¡£</button>
        </div>
    </div>

</div>

<!-- å¼¹çª—ï¼šæ–°å¢ä»»åŠ¡ -->
<div id="modal-task" class="modal" onclick="if(event.target===this)this.style.display='none'">
    <div class="modal-box">
        <h3>æ–°å¢è®¡åˆ’</h3>
        <input id="in-task-name" placeholder="è¦åšä»€ä¹ˆï¼Ÿ">
        <!-- ä¸‹æ‹‰èœå•ç°åœ¨æ˜¯åŠ¨æ€ç”Ÿæˆçš„ -->
        <select id="in-task-tag"></select> 
        <button class="btn-action" onclick="addTask()">ç¡®è®¤</button>
    </div>
</div>

<!-- å¼¹çª—ï¼šæ–°å¢Boss -->
<div id="modal-boss" class="modal" onclick="if(event.target===this)this.style.display='none'">
    <div class="modal-box">
        <h3>è®¾å®šç›®æ ‡</h3>
        <input id="in-boss-name" placeholder="ç›®æ ‡åç§°">
        <select id="in-boss-tag"></select>
        <button class="btn-action" onclick="addBoss()">ç¡®è®¤</button>
    </div>
</div>

<div id="toast" class="toast">å®Œæˆï¼</div>

<script>
    // === éŸ³æ•ˆ ===
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let audioCtx = new AudioCtx();
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        if (type === 'click') {
            osc.frequency.setValueAtTime(600, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime+0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.start(); osc.stop(audioCtx.currentTime+0.1);
        } else if (type === 'success') {
            osc.frequency.setValueAtTime(500, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(1000, audioCtx.currentTime+0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.start(); osc.stop(audioCtx.currentTime+0.3);
        }
    }

    // === æ•°æ® ===
    const DB_KEY = 'NookLife_v11';
    let db = {
        player: { lvl: 1, xp: 0, maxXp: 100, gold: 0, inventory: [] },
        tasks: [], bosses: [], 
        // V11 æ–°å¢ï¼šè‡ªå®šä¹‰æ ‡ç­¾
        tags: [
            {id: 'law', name: 'ğŸ“˜ æ³•å¾‹'},
            {id: 'tech', name: 'ğŸ”¬ ç§‘æŠ€'},
            {id: 'body', name: 'ğŸƒ å¥èº«'},
            {id: 'art', name: 'ğŸ¨ è‰ºæœ¯'}
        ]
    };

    const ITEMS = [
        {id:1, name:"å¶å­ä¼", icon:"ğŸƒ", cost:200},
        {id:2, name:"èƒ½å‰§é¢å…·", icon:"ğŸ‘º", cost:500}
    ];

    function init() {
        const saved = localStorage.getItem(DB_KEY) || localStorage.getItem('NookLife_v10');
        if(saved) {
            try { 
                const loaded = JSON.parse(saved);
                db = {...db, ...loaded}; 
                // ç¡®ä¿æ—§å­˜æ¡£ä¹Ÿæœ‰tagså­—æ®µ
                if(!db.tags || db.tags.length === 0) {
                    db.tags = [
                        {id: 'law', name: 'ğŸ“˜ æ³•å¾‹'},
                        {id: 'tech', name: 'ğŸ”¬ ç§‘æŠ€'},
                        {id: 'body', name: 'ğŸƒ å¥èº«'},
                        {id: 'art', name: 'ğŸ¨ è‰ºæœ¯'}
                    ];
                }
            } catch(e){}
        }
        checkTime(); setInterval(checkTime, 60000);
        render();
    }

    function checkTime() {
        const h = new Date().getHours();
        document.getElementById('clock').innerText = new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'});
        if(h>=18||h<6) { document.body.classList.add('night'); document.getElementById('day-icon').innerText='ğŸŒ™'; }
        else { document.body.classList.remove('night'); document.getElementById('day-icon').innerText='â˜€ï¸'; }
    }

    function save() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }

    // === æ ¸å¿ƒé€»è¾‘ ===

    // åˆ é™¤ä»»åŠ¡
    function deleteTask(id) {
        if(confirm("ç¡®å®šè¦æ’•æ‰è¿™ä¸ªè®¡åˆ’å—ï¼Ÿ")) {
            db.tasks = db.tasks.filter(t => t.id !== id);
            save(); render();
            playSound('click');
        }
    }

    // å®Œæˆä»»åŠ¡
    function doTask(id) {
        const t = db.tasks.find(x=>x.id===id);
        if(!t) return;
        playSound('success');
        
        db.player.gold += 20; db.player.xp += t.val;
        
        const boss = db.bosses.find(b=>b.tag===t.tag);
        if(boss) { boss.hp -= t.val; if(boss.hp<0) boss.hp=0; }
        
        if(db.player.xp >= db.player.maxXp) {
            db.player.lvl++; db.player.xp=0; db.player.maxXp+=20;
            showToast("âœ¨ å‡çº§äº†ï¼");
        } else {
            showToast(`å®Œæˆï¼+${t.val}XP`);
        }
        save(); render();
    }

    // æ·»åŠ ä»»åŠ¡/BOSS
    function addTask() {
        const n = document.getElementById('in-task-name').value;
        const tag = document.getElementById('in-task-tag').value;
        if(n) {
            db.tasks.push({id:Date.now(), name:n, tag:tag, val:30});
            save(); render(); document.querySelector('#modal-task').style.display='none';
            playSound('click');
        }
    }
    function addBoss() {
        const n = document.getElementById('in-boss-name').value;
        const tag = document.getElementById('in-boss-tag').value;
        if(n) {
            db.bosses.push({id:Date.now(), name:n, tag:tag, hp:500, maxHp:500});
            save(); render(); document.querySelector('#modal-boss').style.display='none';
            playSound('click');
        }
    }

    // åˆ†ç±»ç®¡ç†é€»è¾‘
    function addTag() {
        const n = document.getElementById('in-new-tag').value;
        if(n) {
            const id = 'tag_' + Date.now(); // ç”Ÿæˆå”¯ä¸€ID
            db.tags.push({id: id, name: n});
            document.getElementById('in-new-tag').value = '';
            save(); render();
            playSound('click');
        }
    }
    function delTag(id) {
        if(db.tags.length <= 1) { alert("è‡³å°‘ä¿ç•™ä¸€ä¸ªåˆ†ç±»å“¦"); return; }
        if(confirm("åˆ é™¤è¿™ä¸ªåˆ†ç±»å—ï¼Ÿ")) {
            db.tags = db.tags.filter(t => t.id !== id);
            save(); render();
        }
    }

    // === æ¸²æŸ“ ===
    function render() {
        const p = db.player;
        document.getElementById('gold').innerText = p.gold;
        document.getElementById('lvl').innerText = p.lvl;
        document.getElementById('xp-bar').style.width = (p.xp/p.maxXp*100) + '%';
        document.getElementById('xp-text').innerText = p.xp + '/' + p.maxXp;

        // 1. æ¸²æŸ“ä¸‹æ‹‰èœå• (åŠ¨æ€ç”Ÿæˆ)
        const optionsHtml = db.tags.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        document.getElementById('in-task-tag').innerHTML = optionsHtml;
        document.getElementById('in-boss-tag').innerHTML = optionsHtml;

        // 2. æ¸²æŸ“åˆ†ç±»ç®¡ç†åˆ—è¡¨
        document.getElementById('tag-list').innerHTML = db.tags.map((t, index) => `
            <div class="tag-pill" style="border-color:${getColor(index)}">
                ${t.name} <span onclick="delTag('${t.id}')">Ã—</span>
            </div>
        `).join('');

        // 3. æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ (å¸¦åˆ é™¤æŒ‰é’®)
        document.getElementById('task-list').innerHTML = db.tasks.map(t => {
            const tagObj = db.tags.find(tag => tag.id === t.tag) || {name: 'æœªçŸ¥', id: 'unknown'};
            const colorClass = 'tag-color-' + (db.tags.indexOf(tagObj) % 6); // å¾ªç¯é¢œè‰²
            
            return `
            <div class="task-card ${colorClass}">
                <div class="btn-del" onclick="deleteTask(${t.id})">Ã—</div>
                <div style="font-weight:900; font-size:1.1rem; padding-right:20px;">${t.name}</div>
                <div style="font-size:0.8rem; opacity:0.6; margin-top:5px;">${tagObj.name} | +${t.val}XP</div>
                <button class="btn-action" onclick="doTask(${t.id})">å®Œæˆä»»åŠ¡ï¼</button>
            </div>`;
        }).join('');
        
        // 4. æ¸²æŸ“ Boss
        document.getElementById('boss-list').innerHTML = db.bosses.map(b => {
            const tagObj = db.tags.find(tag => tag.id === b.tag) || {name: 'æœªçŸ¥'};
            const colorClass = 'tag-color-' + (db.tags.indexOf(tagObj) % 6);
            
            return `
            <div class="task-card ${colorClass}">
                <div style="display:flex; justify-content:space-between">
                    <b>${b.name}</b> <small onclick="db.bosses=db.bosses.filter(x=>x.id!==${b.id});save();render()">æ”¾å¼ƒ</small>
                </div>
                <div style="font-size:0.8rem; opacity:0.6; margin-bottom:5px;">${tagObj.name}</div>
                <div style="background:#ddd; height:10px; border-radius:5px;"><div style="width:${b.hp/b.maxHp*100}%; background:#F06B6B; height:100%; border-radius:5px; transition:0.3s"></div></div>
            </div>`;
        }).join('');

        // 5. æ¸²æŸ“å•†åº—
        document.getElementById('shop-list').innerHTML = ITEMS.map(i => `
            <div style="background:var(--card-bg); padding:15px; border-radius:15px; text-align:center;">
                <div style="font-size:2rem">${i.icon}</div>
                <div>${i.name}</div>
                <button class="btn-action" style="padding:5px; margin-top:5px;" onclick="if(db.player.gold>=${i.cost}){db.player.gold-=${i.cost};db.player.inventory.push(${i.id});save();render();playSound('success')}else{alert('é’±ä¸å¤Ÿ')}">${i.cost}</button>
            </div>
        `).join('');
    }

    function getColor(index) {
        const colors = ['#6BA2F0', '#F06B6B', '#A86BF0', '#F06BC9', '#F4A261', '#2ECC71'];
        return colors[index % colors.length];
    }

    // äº¤äº’è¾…åŠ©
    function openPage(id) { playSound('click'); document.getElementById('page-'+id).classList.add('active'); }
    function closePage() { playSound('click'); document.querySelectorAll('.sub-page').forEach(e=>e.classList.remove('active')); }
    function openModal(id) { playSound('click'); document.getElementById(id).style.display='flex'; }
    function showToast(msg) { const t=document.getElementById('toast'); t.innerText=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',2000); }
    function exportData() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(db)); a.download="nook_save.json"; a.click(); }
    function importData() { const i=document.createElement('input'); i.type='file'; i.onchange=e=>{ const r=new FileReader(); r.onload=ev=>{ db=JSON.parse(ev.target.result); save(); render(); alert('è¯»å–æˆåŠŸ'); }; r.readAsText(e.target.files[0]); }; i.click(); }

    init();
</script>
</body>
</html>